<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="FundNest.css" />
  </head>
  <body>
    <div class="container">
      <!-- NavBar -->
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">LOGO</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="index.html"
                  >Home</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#aboutFundnest">About</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#blogs">Blogs</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#contact">Contact</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="Consultancy.html">Consult Us</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="Resources.html">Resources</a>
              </li>

              <li class="nav-item" id="entrepreneurIdea" style="display: none">
                <a class="nav-link" href="EntrepreneurIdeas.html"
                  >Entrepreneur Ideas</a
                >
              </li>
              <!-- <li class="nav-item" id="investorIdea" style="display: none">
                <a class="nav-link" href="InvestorIdeas.html">Investor Ideas</a>
              </li> -->
              <li class="nav-item" id="investorlist" style="display: none">
                <a class="nav-link" href="InvestorPane.html">Investor List</a>
              </li>
              <li class="nav-item" id="entrepreneurList" style="display: none">
                <a class="nav-link" href="EntrepreneurPane.html"
                  >Entrepreneur List</a
                >
              </li>
              <li class="nav-item" id="investorprofile" style="display: none">
                <a class="nav-link" href="InvestorProfilePage.html"
                  >Your Profile</a
                >
              </li>
              <li
                class="nav-item"
                id="entrepreneurprofile"
                style="display: none"
              >
                <a class="nav-link" href="EntrepreneurProfilePage.html"
                  >Your Profile</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" id="loginLink" href="Login.html">Login</a>
              </li>
              <li class="nav-item">
                <button class="nav-link" id="logoutLink" href="index.html">
                  Log Out
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <div class="d-flex flex-column" style="height: 100vh; padding: 1rem">
        <div class="d-flex align-items-center p-4 bg-light gap-4">
          <!-- <a href="InvestorProfile.html"
            ><button class="mr-4 border-0 bg-light px-3">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                fill="currentColor"
                class="bi bi-arrow-left text-primary"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"
                />
              </svg></button
          ></a> -->
          <img
            class="rounded-circle"
            style="width: 5rem; height: 5rem"
            src="Images/IMG_2025-1.jpg"
            alt="User Avatar"
          />
          <div class="ml-4">
            <h2 class="fw-semibold text-primary" id="entrepreneurName">
              James
            </h2>
            <p class="text-muted small">Active Now</p>
          </div>
        </div>

        <div class="flex-grow-1 overflow-auto p-4">
          <div id="messageContainer"></div>

          <!-- <div class="d-flex justify-content-end mb-4">
            <div
              style="margin-top: 5rem; margin-right: -7rem; max-width: 40rem"
            >
              <div class="bg-primary text-white px-3 py-1 rounded shadow-sm">
                <p id="messageDisplay">
                  Lorem ipsum dolor sit amet. Aut dolorem corrupti aut quia enim
                  cum dignissimos nobis. Quo recusandae tempora est rerum ipsum
                  qui nostrum velit quo facere obcaecati ea quidem voluptatibus
                  et obcaecati ipsum!
                </p>
              </div>
            </div>
            <div class="d-flex">
              <p
                class="text-right font-weight-bold text-primary"
                style="margin-right: 1rem; margin-top: 1rem"
                
              >
                Amit Kumar
              </p>
              <img
                class="rounded-circle ml-4"
                style="width: 4rem; height: 4rem"
                src="Images/IMG_2025-1.jpg"
                alt="Your Avatar"
              />
            </div>
          </div> -->
        </div>

        <div class="d-flex align-items-center p-4 bg-light position-relative">
          <input
            type="text"
            class="flex-grow-1 form-control border-primary rounded-5"
            placeholder="Type your message here"
            style="height: 4rem"
            id="messageInput"
          />
          <button
            class="ml-4 border-0 position-absolute"
            style="right: 40px"
            id="sendButton"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="30"
              height="30"
              fill="currentColor"
              class="bi bi-send-arrow-up-fill text-primary"
              viewBox="0 0 16 16"
            >
              <path
                fill-rule="evenodd"
                d="M15.854.146a.5.5 0 0 1 .11.54L13.026 8.03A4.5 4.5 0 0 0 8 12.5c0 .5 0 1.5-.773.36l-1.59-2.498L.644 7.184l-.002-.001-.41-.261a.5.5 0 0 1 .083-.886l.452-.18.001-.001L15.314.035a.5.5 0 0 1 .54.111M6.637 10.07l7.494-7.494.471-1.178-1.178.471L5.93 9.363l.338.215a.5.5 0 0 1 .154.154z"
              />
              <path
                fill-rule="evenodd"
                d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.354-5.354a.5.5 0 0 0-.722.016l-1.149 1.25a.5.5 0 1 0 .737.676l.28-.305V14a.5.5 0 0 0 1 0v-1.793l.396.397a.5.5 0 0 0 .708-.708z"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      function updateNavbar() {
        const token = localStorage.getItem("token");
        const loginLink = document.getElementById("loginLink");
        const logoutLink = document.getElementById("logoutLink");

        if (token) {
          loginLink.style.display = "none";
          logoutLink.style.display = "block";
        } else {
          loginLink.style.display = "block";
          logoutLink.style.display = "none";
        }
      }

      updateNavbar();

      // Function to check user type and update navigation items
      async function updateUserNavigation(token) {
        try {
          const response = await axios.get(
            "http://103.189.172.172:3000/check/role",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.status === 200) {
            // console.log(response.data);
            const userType = response.data.role;
            // console.log(userType);
            if (userType === "investor") {
              document.getElementById("entrepreneurList").style.display =
                "block";
              document.getElementById("entrepreneurIdea").style.display =
                "block";
              document.getElementById("investorprofile").style.display =
                "block";
            } else if (userType === "enterprenuer") {
              document.getElementById("investorlist").style.display = "block";
              document.getElementById("investorIdea").style.display = "block";
              document.getElementById("entrepreneurprofile").style.display =
                "block";
            }
          } else {
            console.error("Failed to fetch user type:", response.statusText);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (token) {
          updateUserNavigation(token);
        }
      });

      // Function to handle logout
      async function handleLogout() {
        try {
          const response = await axios.post(
            "http://103.189.172.172:3000/auth/logout"
          );
          alert(response.data.message);
          localStorage.removeItem("token");
          window.location.href = "index.html";
        } catch (error) {
          console.error("Logout error:", error);
          alert("Logout failed. Please try again.");
        }
      }

      // Add event listener to the logout link
      document
        .getElementById("logoutLink")
        .addEventListener("click", function (event) {
          event.preventDefault(); // Prevent default link behavior
          handleLogout(); // Call the logout function when link is clicked
        });
    </script>

    <script>
      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return Object.fromEntries(params.entries());
      }
      const params = getQueryParams();
      const receiverId = params.id;
      const investorId = localStorage.getItem("user");
      const roomId = investorId + "" + receiverId;
      // console.log("vf",roomId);

      // Fetch entrepreneur details from server
      async function fetchEntrepreneurDetails() {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            console.error("Token not found");
            return;
          }

          const params = getQueryParams();
          const entrepreneurId = params.id;
          // console.log(entrepreneurId);

          const response = await axios.get(
            `http://103.189.172.172:3000/investor/enterprenuer/${entrepreneurId}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.status !== 200) {
            throw new Error(
              response.data.message || "Failed to fetch entrepreneur details"
            );
          }

          const { entrepreneur } = response.data;
          document.getElementById("entrepreneurName").textContent =
            entrepreneur.name;
        } catch (error) {
          console.error("Error fetching entrepreneur details:", error.message);
          alert(
            "Failed to fetch entrepreneur details. Please try again later."
          );
        }
      }

      // Function to fetch messages
      async function fetchMessages() {
        const params = getQueryParams();
        const entrepreneurId = params.id;

        const token = localStorage.getItem("token");
        if (!token) {
          console.error("Token not found");
          return;
        }

        try {
          const response = await axios.get(
            `http://103.189.172.172:3000/enterprenuer/${roomId}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.status === 200) {
            displayMessages(response.data.messages);
          } else {
            console.error(`Error: ${response.data.message}`);
          }
        } catch (error) {
          console.error("Error fetching messages:", error);
        }
      }

      // Function to display messages
      function displayMessages(messages) {
        const messageContainer = document.getElementById("messageContainer");
        messageContainer.innerHTML = "";

        messages.forEach((message) => {
          const messageElement = `
        <div>
          <div class="d-flex ${
            message.senderId == investorId
              ? "justify-content-end"
              : "justify-content-start "
          } mb-4 ">
            <div style="margin-top: 5rem; max-width: 40rem">
              <div class=" ${
                message.senderId == investorId ? "bg-dark" : "bg-primary "
              } text-white px-3 py-1 rounded shadow-sm">
                <p>${message.message}</p>
              </div>
            </div>

        </div>`;

          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = messageElement;

          while (tempDiv.firstChild) {
            messageContainer.appendChild(tempDiv.firstChild);
          }
        });
      }

      // Event listener for the send button
      document
        .getElementById("sendButton")
        .addEventListener("click", async () => {
          const messageInput = document.getElementById("messageInput");
          const message = messageInput.value.trim();

          const token = localStorage.getItem("token");
          if (!token) {
            console.error("Token not found");
            return;
          }

          // console.log(investorId);
          if (!investorId) {
            console.error("Entrepreneur not found");
            return;
          }

          try {
            const response = await axios.post(
              `http://103.189.172.172:3000/enterprenuer/send-message/${investorId}`,
              { message, receiverId, roomId },
              { headers: { Authorization: `Bearer ${token}` } }
            );

            if (response.status === 200) {
              messageInput.value = "";
              fetchMessages(); // Refresh messages after sending
            } else {
              alert(`Error: ${response.data.message}`);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while sending the message.");
          }
        });

      // Fetch entrepreneur details and messages on page load
      window.onload = () => {
        fetchEntrepreneurDetails();
        fetchMessages();
      };
    </script>
  </body>
</html>
